/* ==================== 标签超市通用布局 ==================== */
.tsp-modal-xlarge {
    width: min(11800px, 85vw);
    height: min(1200px, 80vh);
}
.ts-layout {
    display: flex;
    height: 100%;
    gap: 15px;
    color: var(--tsp-text-primary);
    position: relative;
}

.ts-left-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 0;
    /* 修改点：允许左侧面板整体纵向滚动 */
    overflow-y: auto;
    height: 100%;
}


.ts-right-panel {
    width: 320px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    border-left: 1px solid var(--tsp-border);
    padding-left: 15px;
    flex-shrink: 0;
}

/* ==================== 搜索与导航 ==================== */
.ts-search-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 10px;
    padding: 10px;
    background: rgba(0,0,0,0.15);
    border-radius: 8px;
}

.ts-search-item label {
    display: block;
    font-size: 0.85em;
    color: var(--tsp-text-secondary);
    margin-bottom: 4px;
}

.ts-search-box {
    display: flex;
    gap: 5px;
}

.ts-search-box input {
    flex: 1;
}

/* 分类按钮 */
.ts-categories {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    padding: 5px 0;
}

.ts-category-btn {
    padding: 6px 12px;
    background: var(--tsp-bg-input);
    border: 1px solid var(--tsp-border);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}

.ts-category-btn:hover {
    background: var(--tsp-bg-secondary);
    border-color: var(--tsp-accent-primary);
}

.ts-category-btn.active {
    background: var(--tsp-accent-primary);
    color: white;
    border-color: var(--tsp-accent-primary);
}

#ts-main-cats .ts-category-btn {
    background: rgba(122, 162, 247, 0.15);
    border-color: var(--tsp-accent-primary);
    font-weight: bold;
}

#ts-sub-cats .ts-category-btn {
    background: rgba(0, 0, 0, 0.2);
    border: 1px dashed var(--tsp-border);
    font-size: 0.9em;
    color: var(--tsp-text-secondary);
}

#ts-sub-cats .ts-category-btn.active {
    background: var(--tsp-accent-secondary);
    border-style: solid;
    color: #fff;
}

/* ==================== 内容区域 (Tag卡片/图片) ==================== */
.ts-content {
    /* 修改点：取消 flex: 1，改为 none，允许高度被内容撑开 */
    flex: none;
    height: auto;
    /* 修改点：取消内部滚动，内容展示完整 */
    overflow: visible;
    padding: 5px;
    min-height: 200px;
    border: 1px solid var(--tsp-border);
    border-radius: 8px;
    background: rgba(0,0,0,0.1);
    position: relative;
}


.ts-content-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 10px;
}

/* 卡片样式 */
.ts-card {
    background: var(--tsp-bg-input);
    border: 1px solid var(--tsp-border);
    border-radius: 6px;
    padding: 8px;
    cursor: pointer;
    transition: transform 0.2s;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.ts-card:hover {
    transform: translateY(-2px);
    border-color: var(--tsp-accent-primary);
}
.ts-card.selected {
    border-color: var(--tsp-accent-primary);
    background-color: color-mix(in srgb, var(--tsp-accent-primary) 15%, transparent);
    transform: translateY(-1px);
    box-shadow: 0 0 8px color-mix(in srgb, var(--tsp-accent-primary) 30%, transparent);
}

.ts-card.selected::before {
    content: '✔';
    position: absolute;
    top: 4px;
    right: 6px;
    color: var(--tsp-accent-primary);
    font-size: 1.1em;
    font-weight: bold;
    text-shadow: 0 0 4px var(--tsp-bg-input);
}

/* 同样为 Danbooru 列表行添加选中样式 */
.ts-danbooru-row.selected {
    background: rgba(122, 162, 247, 0.25); /* 使用与 hover 类似的颜色，但更深一些 */
    border-left: 3px solid var(--tsp-accent-primary);
    padding-left: 9px;
}
.ts-card-img-wrap {
    width: 100%;
    aspect-ratio: 2/3;
    background: #111;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    border-radius: 4px;
}

.ts-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.ts-card-text {
    font-size: 0.85em;
    font-weight: bold;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.ts-card-sub {
    font-size: 0.75em;
    color: var(--tsp-text-muted);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* 标签选择结果列表 */
.tsp-tag-result-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.tsp-tag-result {
    display: inline-flex;
    align-items: center;
    padding: 4px 10px;
    border-radius: 999px;
    background: var(--tsp-bg-main);
    border: 1px solid var(--tsp-border);
    cursor: pointer;
    transition: all 0.15s ease;
}

.tsp-tag-result.active {
    background: var(--tsp-accent-primary);
    color: #fff;
    border-color: var(--tsp-accent-primary);
}

/* ==================== Danbooru 专用样式 ==================== */
.ts-danbooru-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 12px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    cursor: pointer;
    align-items: center;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.ts-danbooru-row:hover {
    background: rgba(122, 162, 247, 0.15);
}

.ts-danbooru-count {
    background: rgba(255,255,255,0.1);
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 0.75em;
    color: var(--tsp-text-muted);
}

.danbooru-post-card {
    padding: 5px;
}

.ts-card-tags-area {
    height: 50px;
    overflow: hidden;
    font-size: 0.75em;
    line-height: 1.5;
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    padding: 5px;
    border-top: 1px solid var(--tsp-border);
    cursor: copy;
}

.ts-card-tag-chip {
    background: var(--tsp-bg-secondary);
    padding: 2px 6px;
    border-radius: 4px;
    white-space: nowrap;
}

/* ==================== 右侧预览与加载 ==================== */
#ts-preview-area {
    flex: 1;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid var(--tsp-border);
    min-height: 200px;
    position: relative;
}

#ts-preview-area img,
#ts-preview-area video {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.ts-loading {
    font-size: 2em;
    color: var(--tsp-accent-primary);
    animation: spin 1s linear infinite;
}

@keyframes spin { 100% { transform: rotate(360deg); } }

/* ==================== 详情视图 (P-Gallery) ==================== */
.ts-detail-view {
    display: flex;
    flex-direction: column;
    gap: 15px;
    height: 100%;
}

.ts-detail-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--tsp-border);
    padding-bottom: 10px;
}

.ts-detail-content {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.ts-detail-item {
    display: flex;
    gap: 15px;
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 8px;
}

.ts-detail-img {
    width: 200px;
    flex-shrink: 0;
}

.ts-detail-img img {
    width: 100%;
    border-radius: 4px;
    cursor: zoom-in;
}

.ts-detail-meta {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 5px;
}

/* ==================== 移动端深度适配 ==================== */
@media (max-width: 900px) {
    .tsp-modal-xlarge {
        width: 95%;
        height: 90dvh;
        max-width: none;
        max-height: none;
        border-radius: 0;
        border-radius: 8px;
        margin-bottom: 10vh;
    }
    /* 1. 让 Modal Body 负责整体滚动，而不是禁止溢出 */
    .tsp-modal-body {
        overflow-y: auto !important; /* 允许竖向滚动 */
        overflow-x: hidden;
        display: flex;
        flex-direction: column;
        position: relative; /* 为吸底元素提供定位上下文 */
    }

    /* 2. 布局调整：取消 Flex 锁定，允许内容撑开高度 */
    .ts-layout {
        flex-direction: column;
        height: auto !important; /* 允许高度随内容增长 */
        min-height: 100%;
        gap: 0; /* 去除间隙，由 Padding 控制 */
    }

    /* 3. 右侧面板 (预览区+功能按钮) */
    .ts-right-panel {
        flex: 0 0 auto; /* 不伸缩 */
        width: 100%;
        height: auto;
        padding: 10px 0;
        order: -1; /* 放在最顶部 */
        padding-left: 0;
        border-left: none;
        border-bottom: 1px solid var(--tsp-border);
    }
    #ts-preview-area { height: 200px; } /* 固定预览高度 */

    /* 4. 左侧面板 (标签内容区) */
    .ts-left-panel {
        flex: 1 0 auto; /* 允许伸长 */
        overflow: visible !important; /* 解除内部滚动限制 */
        min-height: 0;
        display: flex;
        flex-direction: column;
    }

    /* 5. 移动端内容包裹层 */
    .ts-mobile-content-wrap {
        display: none;
        width: 100%;
        /* 关键：取消 flex: 1，允许内容无限撑开 */
        flex: none;
        height: auto;
        overflow: visible;
        flex-direction: column;
        order: 1;
        /* 给底部吸底按钮留出空间，防止内容被遮挡 */
        padding: 0 5px 60px 5px;
    }
    .ts-mobile-content-wrap.active { display: flex; }

    /* 6. 内容区域 (#ts-content-area) 修复：无限拉伸 */
    #ts-content-area {
        min-height: 400px !important; /* 给个最小高度方便查看 */
        flex: none !important;        /* 禁止 Flex 计算高度 */
        height: auto !important;      /* 随内容自动增高 */
        overflow-y: visible !important; /* 显示所有内容，不截断 */
    }
    /* 修复网格在移动端的列数 */
    .ts-content-grid {
        grid-template-columns: 1fr 1fr !important;
        gap: 8px; /* 保持间距 */
    }
    /* 特殊处理：NAI 画师需要保持单列 (因为卡片信息比较宽) */
    .ts-content-grid.ts-nai-artist-grid {
        grid-template-columns: 1fr !important;
    }
    /* 7. 核心：折叠按钮吸底 (Sticky) */
    .ts-mobile-toggle {
        order: 2;
        /* 必须设置为 sticky 才能在滚动容器内吸底 */
        position: sticky;
        bottom: 0;
        left: 0;
        width: 100%;
        /* 样式美化 */
        height: 44px;
        flex: 0 0 44px;
        border-top: 1px solid var(--tsp-accent-primary);
        background: var(--tsp-bg-input); /* 确保不透明 */
        backdrop-filter: blur(10px);     /* 毛玻璃效果 */
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 -4px 15px rgba(0,0,0,0.3); /* 阴影突出层次 */
        margin-top: auto; /* 辅助定位 */
    }

    /* 展开模式下的特殊处理 (隐藏预览区) */
    .ts-layout.mobile-expanded-mode .ts-right-panel {
        display: none !important;
    }

    /* 搜索框适配保持不变... */
    .ts-search-grid { display: flex; flex-direction: column; gap: 8px; padding: 5px 0; }
    .ts-search-item label { display: none; }
    .ts-search-box { width: 100%; gap: 8px; }
    .ts-search-box input { flex: 1; min-height: 40px; width: 0; }
    .ts-search-box button { flex: 0 0 50px; height: 40px; }

    /* 1. 详情页容器：解除高度限制 */
    .ts-detail-view {
        height: auto !important;
        min-height: 100%;
        overflow: visible;
        display: block; /* 防止 flex 干扰 */
    }
    .ts-detail-content {
        overflow: visible !important;
        flex: none !important;
        display: block;
    }
    /* 2. 详情项：强制改为竖向排列 (上图下文)，并限制宽度 */
    .ts-detail-item {
        display: flex !important;
        flex-direction: column !important; /* 关键：变回竖排 */
        width: 100% !important; /* 强制宽度不超屏幕 */
        box-sizing: border-box; /* 让 padding 包含在宽度内 */
        gap: 10px;
        margin-bottom: 20px;
    }

    /* 3. 图片容器：占满屏幕宽度 */
    .ts-detail-img {
        width: 100% !important;
        max-width: 100% !important;
    }

    /* 4. 文字区域：防止长文本把容器撑宽 */
    .ts-detail-meta {
        width: 100% !important;
        min-width: 0; /* Flex 布局下的防溢出大法 */
        word-wrap: break-word; /* 强制换行 */
        overflow-wrap: break-word;
    }
    /* 代码块内部也要允许滚动/换行 */
    .ts-code-block {
        white-space: pre-wrap !important;
        word-break: break-all !important;
    }
}
#ts-content-area {
    /* 删除原有的 min-height: 65vh !important 等强制代码 */

    /* 1. PC端核心修复：利用 Flex 剩余空间，内部独立滚动 */
    flex: 1;
    min-height: 0; /* 关键：允许 Flex 容器收缩 */
    overflow-y: auto; /* PC端内部滚动 */
    height: 100%;     /* 撑满父容器高度 */

    /* 2. 视觉优化 */
    background: rgba(0,0,0,0.1); /* 保持原有背景 */
    position: relative;
}

/* ==================== 标签超市自定义功能样式 ==================== */

/* 功能控制按钮（添加/删除） */
.ts-control-btn {
    width: 32px;
    padding: 0 !important;
    text-align: center;
    display: inline-flex;
    justify-content: center;
    align-items: center;
    font-size: 14px;
}

.ts-control-btn.success {
    color: #4caf50;
    border-color: #4caf50;
    background: rgba(76, 175, 80, 0.1);
}
.ts-control-btn.success:hover {
    background: rgba(76, 175, 80, 0.2);
}

.ts-control-btn.danger {
    color: #f44336;
    border-color: #f44336;
    background: rgba(244, 67, 54, 0.1);
}
.ts-control-btn.danger:hover {
    background: rgba(244, 67, 54, 0.2);
}
.ts-control-btn.danger.active {
    background: #f44336;
    color: white;
}

/* 批量删除选中状态 - 子分类 */
.ts-category-btn.ts-delete-selected {
    background-color: #ffebee !important;
    border-color: #f44336 !important;
    color: #d32f2f !important;
    text-decoration: line-through;
    opacity: 0.8;
}

/* 标签网格内的操作卡片 (大加号/大垃圾桶) */
.ts-card-action {
    /* 移除之前的 flex 居中和最小高度 */
    min-height: auto;
    border: 1px dashed var(--tsp-border); /* 保持虚线以示区别，但边框变细 */
    display: flex;
    flex-direction: column; /* 保持上下结构 */
    gap: 4px;
    justify-content: center;
}

/* 颜色定义保持不变，但可以微调背景色使其更融合 */
.ts-card-action.success {
    color: #4caf50;
    border-color: #4caf50;
    background: rgba(76, 175, 80, 0.05);
}
.ts-card-action.success:hover {
    background: rgba(76, 175, 80, 0.15);
}

.ts-card-action.danger {
    color: #f44336;
    border-color: #f44336;
    background: rgba(244, 67, 54, 0.05);
}
.ts-card-action.danger:hover {
    background: rgba(244, 67, 54, 0.15);
}
.ts-card-action.danger.active {
    background: #f44336;
    color: white;
    border-style: solid;
}

/* 批量删除选中状态 - 标签卡片 */
.ts-card.ts-delete-selected {
    border-color: #f44336;
    background-color: rgba(244, 67, 54, 0.1);
    position: relative;
}
.ts-card.ts-delete-selected::after {
    content: "✘";
    position: absolute;
    top: 2px;
    right: 5px;
    color: #f44336;
    font-weight: bold;
    font-size: 1.2em;
}
.tsp-modal-header .tsp-btn-icon.close-modal {
    background: transparent;
    color: var(--tsp-text-primary);
    border: none;
    opacity: 0.7;
    font-size: 1.2em;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.tsp-modal-header .tsp-btn-icon.close-modal:hover {
    opacity: 1;
    background-color: var(--tsp-bg-secondary); /* 悬停时显示淡淡的主题背景色 */
}
/* ==================== 标签超市按钮特效 (柔和护眼版) ==================== */

/* --- 通用设置：字体与过渡 --- */
.ts-category-btn {
    font-weight: 600;
    letter-spacing: 0.5px;
    position: relative;
    overflow: hidden;
    border-radius: 6px;
    backdrop-filter: blur(2px);
    /* 默认边框，防止变量未加载时消失 */
    border: 1px solid transparent;
}

/* -----------------------------------------------------------
   特殊功能按钮 (Danbooru/NAI/更衣人偶)
   变量化改造
   ----------------------------------------------------------- */
.ts-category-btn.ts-btn-special {
    /* 使用变量，提供玄色作为回退值 */
    border-color: var(--tsp-tag-special-border, rgba(255, 189, 222, 0.5)) !important;
    color: var(--tsp-tag-special-text, #ffdaeb);
    background: var(--tsp-tag-special-bg, rgba(255, 189, 222, 0.05));
    box-shadow: 0 0 10px rgba(255, 189, 222, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 悬停效果 */
.ts-category-btn.ts-btn-special:hover {
    background: var(--tsp-tag-special-hover-bg, rgba(255, 189, 222, 0.15));
    /* 悬停时边框颜色跟随主色 */
    border-color: var(--tsp-tag-special-text, #ffbdde) !important;
    color: var(--tsp-text-primary); /* 稍微提亮文字 */
    box-shadow: 0 0 15px rgba(255, 189, 222, 0.3);
    transform: translateY(-1px);
}

/* 选中状态 - 保持高亮 */
.ts-category-btn.ts-btn-special.active {
    /* 选中时使用主颜色填充，或者使用渐变 */
    background: var(--tsp-tag-special-border, #ff9ec6) !important;
    border-color: var(--tsp-tag-special-text, #ff9ec6) !important;
    box-shadow: 0 4px 15px rgba(255, 158, 198, 0.4);
    /* 选中时文字设为白色或深色，视背景而定，这里假设深色模式下用深色字 */
    color: var(--tsp-bg-main, #4a2c36);
    text-shadow: none;
}

/* -----------------------------------------------------------
   自定义按钮
   变量化改造
   ----------------------------------------------------------- */
.ts-category-btn.ts-btn-custom {
    border-color: var(--tsp-tag-custom-border, rgba(184, 164, 255, 0.5)) !important;
    color: var(--tsp-tag-custom-text, #e2daff);
    background: var(--tsp-tag-custom-bg, rgba(184, 164, 255, 0.05));
    box-shadow: 0 0 10px rgba(184, 164, 255, 0.1);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 悬停效果 */
.ts-category-btn.ts-btn-custom:hover {
    background: var(--tsp-tag-custom-hover-bg, rgba(184, 164, 255, 0.15));
    border-color: var(--tsp-tag-custom-text, #b8a4ff) !important;
    color: var(--tsp-text-primary);
    box-shadow: 0 0 15px rgba(184, 164, 255, 0.3);
    transform: translateY(-1px);
}

/* 选中状态 */
.ts-category-btn.ts-btn-custom.active {
    background: var(--tsp-tag-custom-border, #9e8cfc) !important;
    border-color: var(--tsp-tag-custom-text, #9e8cfc) !important;
    box-shadow: 0 4px 15px rgba(158, 140, 252, 0.4);
    color: var(--tsp-bg-main, #312b4a);
    text-shadow: none;
}

/* 调整原来的主分类按钮间距 */
.ts-categories {
    gap: 12px !important;
    padding: 8px 5px !important;
}
/* H:\SillyTavern-1.13.4\public\scripts\extensions\third-party\chami_tavern-scene-plugin\styles\tag-market.css */

/* ... 在文件末尾追加 ... */

/* ==================== NAI 画师新布局样式 ==================== */
.nai-artist-card {
    background: var(--tsp-bg-input);
    border: 1px solid var(--tsp-border);
    border-radius: 8px;
    padding: 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
}

.nai-artist-card:hover {
    border-color: var(--tsp-accent-primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.nai-artist-card-header {
    /* [修改] 从 flex 改为 grid 布局 */
    display: grid;
    grid-template-columns: 1fr 1fr 1fr; /* [修改] 定义三列，与下方图片网格一致 */
    align-items: center;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    padding: 6px;
    font-size: 0.8em;
    gap: 5px; /* [修改] 缩小 gap 以适应网格布局 */
}

.nai-artist-card-header span {
    cursor: pointer;
    padding: 2px 4px;
    border-radius: 3px;
    transition: background 0.2s;
    /* [新增] 关键样式，让文本在自己的格子内居中和换行 */
    text-align: center;
    word-break: break-word; /* 强制长单词换行 */
    min-width: 0; /* 允许网格项收缩 */
}

.nai-artist-card-header span:hover {
    background: rgba(255, 255, 255, 0.1);
}

.nai-artist-image-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 5px;
    width: 100%;
    aspect-ratio: 3 / 1.5; /* 保持图片区域的比例 */
}

.nai-artist-image-grid .image-wrapper {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
    border-radius: 4px;
}

.nai-artist-image-grid img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.nai-artist-prompt {
    font-size: 0.85em;
    color: var(--tsp-text-secondary);
    background: rgba(0, 0, 0, 0.1);
    padding: 8px;
    border-radius: 4px;
    text-align: center;
    word-break: break-all;
    cursor: copy;
}
/* 1. 确保图片容器可以相对定位 Badge */
.ts-card-img-wrap {
    position: relative;
}

/* 2. Badge 元素的具体样式 */
.ts-card-model-badge {
    position: absolute;
    top: 0;
    left: 0;
    z-index: 2; /* 确保在图片之上 */
    padding: 2px 6px;
    background-color: rgba(0, 0, 0, 0.7);
    color: #ffffff;
    font-size: 0.75em;
    font-weight: bold;
    border-bottom-right-radius: 6px; /* 右下角圆角， tạo hiệu ứng đẹp */
    text-transform: uppercase; /* 让文字大写，例如 'sd' -> 'SD' */
    pointer-events: none; /* 让鼠标可以穿透 Badge 点击下方的图片 */
}
@media (min-width: 901px) {
    .ts-mobile-toggle { display: none; }
    /* 修改点：height 改为 auto，允许包裹内容 */
    .ts-mobile-content-wrap { display: flex !important; flex-direction: column; gap: 10px; height: auto; }
}
